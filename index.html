<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <link rel="stylesheet" href="./assets/css/style.css">
    <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase.js"></script>
    <title>Train Time</title>
</head>

<body>
    <div class="container-fluid">
        <div class="container">
            <div class="jumbotron align-center text-center bg-primary text-white">
                <h1>World of Trains</h1>
            </div>
            <div class="card">
                <div class="card-header bg-primary text-white font-weight-bold">
                    Current Train Schedule
                </div>
                <table class="table table-hover train-table">
                    <thead>
                        <tr>
                            <th scope="col" id="display-train-name">Train Name</th>
                            <th scope="col" id="display-dest">Destination</th>
                            <th scope="col" id="display-frequency">Frequency (min)</th>
                            <th scope="col" id="display-next-arrival">Next Arrival</th>
                            <th scope="col" id="display-minutes-away">Minutes Away</th>
                        </tr>
                    </thead>
                    <tbody>
                        <div class="all-trains">
                            <tr>
                                <td>Vu's Train</td>
                                <td>Graduation</td>
                                <td>86400</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Amtrek</td>
                                <td>Dallas</td>
                                <td>120</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Midnight Train</td>
                                <td>Going Anywhere</td>
                                <td>10</td>
                                <td></td>
                                <td></td>
                            </tr>
                        </div>
                    </tbody>
                </table>
            </div>
            <br>

            <div class="card">
                <div class="card-header bg-primary text-white font-weight-bold">
                    Add Trains
                </div>
                <form>
                    <div class="form-group">
                        <label for="train-name">Train Name</label>
                        <input type="text" class="form-control" id="train-name" placeholder="Amtrek">
                    </div>
                    <div class="form-group">
                        <label for="dest">Destination</label>
                        <input type="text" class="form-control" id="dest" placeholder="Houston">
                    </div>
                    <div class="form-group">
                        <label for="initial-time">First Train Time (HH:MM - Military Time)</label>
                        <input type="text" class="form-control" id="initial-time" placeholder="16:00">
                    </div>
                    <div class="form-group">
                        <label for="frequency">Frequency (min)</label>
                        <input type="text" class="form-control" id="frequency" placeholder="20">
                    </div>
                    <button class="btn btn-primary col-sm-1 mt-2" id="add-train" type="submit">Submit</button>
                </form>
            </div>
            <br>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAljeEssPjfpYWefrsAcZp9OlzV_K-caYQ",
            authDomain: "hello-world1018.firebaseapp.com",
            databaseURL: "https://hello-world1018.firebaseio.com",
            projectId: "hello-world1018",
            storageBucket: "hello-world1018.appspot.com",
            messagingSenderId: "717646869643"
        };

        firebase.initializeApp(config);

        var database = firebase.database();
        var train = "";
        var destination = "";
        var initialTime = "";
        var frequency = "";

        $("#add-train").on("click", function (event) {
            event.preventDefault();

            train = $("#train-name").val().trim();
            destination = $("#dest").val().trim();
            initialTime = $("#initial-time").val().trim();
            frequency = $("#frequency").val().trim();

            var initialTimeConverted = moment(initialTime, "hh:mm").subtract(1, "years");
            var currentTime = moment();
            var diffTime = moment().diff(moment(initialTimeConverted), "minutes");
            var tRemainder = diffTime % frequency;
            var tMinutesTillTrain = frequency - tRemainder;
            var nextArrival = moment().add(tMinutesTillTrain, "minutes").format("hh:mm A");

            database.ref().push({
                train: train,
                destination: destination,
                initialTime: initialTime,
                frequency: frequency,
                nextArrival: nextArrival,
                minutesAway: tMinutesTillTrain,
                currentTime: currentTime,
            });

            $("#train-name").val("");
            $("#dest").val("");
            $("#initial-time").val("");
            $("#frequency").val("");

        });

        database.ref().on("child_added", function (childSnapshot) {
            train = childSnapshot.val().train;
            destination = childSnapshot.val().destination;
            initialTime = childSnapshot.val().initialTime;
            frequency = childSnapshot.val().frequency;
            nextArrival = childSnapshot.val().nextArrival;
            minutesAway = childSnapshot.val().minutesAway;
            currentTime = childSnapshot.val().currentTime;

            var initialTimeConverted = moment(initialTime, "hh:mm").subtract(1, "years");
            var currentTime = moment();
            var diffTime = moment().diff(moment(initialTimeConverted), "minutes");
            var tRemainder = diffTime % frequency;
            var tMinutesTillTrain = frequency - tRemainder;
            var nextArrival = moment().add(tMinutesTillTrain, "minutes").format("hh:mm A");

            var tRow = $("<tr>");
            var trainTd = $("<td>").text(train);
            var destTd = $("<td>").text(destination);
            var frequencyTd = $("<td>").text(frequency);
            var nextArrivalTd = $("<td>").text(nextArrival);
            var minutesAwayTd = $("<td>").text(tMinutesTillTrain);
            console.log(train);
            console.log(destination);


            tRow.append(trainTd, destTd, frequencyTd, nextArrivalTd, minutesAwayTd)
            $(".train-table tr:last").after(tRow);
            console.log(tRow)

        },
            function (errorObject) {
                console.log("Errors handled: " + errorObject.code);
            }
        );

    </script>

</body>

</html>